

<!DOCTYPE html>
<html lang="en">
    <head>

        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="erics">
        <link rel="canonical" href="https://ywyz.pythoneers.cn/kubernetes/kubernetes-network.html">
        <link rel="shortcut icon" href="../img/favicon.ico">
<meta name="keywords"
      content=""/>
<meta http-equiv="Content-Type" content="text/html;charset=gb2312"/>


        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <link href="../css/nav.css" rel="stylesheet">
        <link href="../css/public.css" rel="stylesheet">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-36723568-3', 'mkdocs.org');
            ga('send', 'pageview');
        </script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="..">运维云栈</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Linux <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../linux/linux-basis.html">Linux基础</a>
</li>
                                    
<li >
    <a href="../linux/linux-advance.html">Linux进阶</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Shell <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../shell/shell-basis.html">Shell基础</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">CentOS <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../centos/software-install.html">CentOS软件安装</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Ubuntu <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../ubuntu/software-install.html">Ubuntu软件安装</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Zabbix <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../zabbix/install.html">Zabbix安装</a>
</li>
                                    
<li >
    <a href="../zabbix/monitor-host.html">Zabbix添加监控主机</a>
</li>
                                    
<li >
    <a href="../zabbix/trigger.html">Zabbix添加触发器</a>
</li>
                                    
<li >
    <a href="../zabbix/custom-alarm.html">Zabbix自定义报警</a>
</li>
                                    
<li >
    <a href="../zabbix/custom-graphics.html">Zabbix使用grafana自定义图形</a>
</li>
                                    
<li >
    <a href="../zabbix/custom-template.html">Zabbix自定义模板</a>
</li>
                                    
<li >
    <a href="../zabbix/monitor-mysql.html">Zabbix使用percona监控MySQL</a>
</li>
                                    
<li >
    <a href="../zabbix/automatic-monitor.html">Zabbix自动化监控</a>
</li>
                                    
<li >
    <a href="../zabbix/agent-active-mode.html">Zabbix Agent主动模式</a>
</li>
                                    
<li >
    <a href="../zabbix/version-upgrade.html">Zabbix版本升级</a>
</li>
                                    
<li >
    <a href="../zabbix/performance-tuning.html">Zabbix性能调优</a>
</li>
                                    
<li >
    <a href="../zabbix/distributed-monitor.html">Zabbix分布式监控</a>
</li>
                                    
<li >
    <a href="../zabbix/question.html">Zabbix遇到的问题</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Kubernetes <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="kubernetes-component.html">K8S架构/组件说明</a>
</li>
                                    
<li >
    <a href="kubernetes-install.html">K8S集群安装部署</a>
</li>
                                    
<li class="active">
    <a href="kubernetes-network.html">K8S网络通信</a>
</li>
                                    
<li >
    <a href="kubernetes-resource.html">K8S资源清单</a>
</li>
                                    
<li >
    <a href="kubernetes-question.html">K8S中遇到的问题</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Nginx <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../nginx/nginx-knowledge.html">Nginx知识点</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                            <li >
                                <a rel="next" href="kubernetes-install.html">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="kubernetes-resource.html">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#k8s">K8S网络通信</a></li>
            <li><a href="#1-k8s">1. K8S网络模型</a></li>
            <li><a href="#2-k8s">2. K8S网络解决方案</a></li>
            <li><a href="#3-k8s">3. K8S网络通信方式</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<p><img alt="" src="../imgs/k8s/202011071500.jpeg" /></p>
<h4 id="k8s">K8S网络通信</h4>
<hr>

<h5 id="1-k8s">1. K8S网络模型</h5>
<p>Kubernetes 的网络模型假定了所有 Pod 都在一个可以直接连通的扁平的网络空间中，<font>Kubernetes的扁平化是指所有的 Pod 都可以通过对方的 IP “直接到达”</font>（其实有很多转换机制，如Flannel）。这在GCE（Google Compute Engine）里面是现成的网络模型，Kubernetes 假定这个网络已经存在。<font>而在私有云里搭建 Kubernetes 集群，就不能假定这个网络已经存在了</font>。我们需要自己实现这个网络假设，将不同节点上的 Docker 容器之间的互相访问先打通，然后运行 Kubernetes。<font>Flannel 可以实现这个扁平化的网络空间</font>。</p>
<p>第一种通信模式：<font>同一个 Pod 的多个容器之间的访问通过 lo</font>。同一个 Pod 内的多个容器公用 pause 容器的网络栈，这些容器之间的访问走的是这个网络栈的 IO，不需要网卡，通过 localhost 的方式访问。第二种通信模式：<font>Pod 与 Service 之间的通讯</font>。Pod 与 Service 之间的通讯是通过各节点的 Iptables 规则，<font>最新版本中已经加入了LVS的机制来实现转换，转换效率会更高</font>。第三种通信模式：<font>各 Pod 之间的通讯</font>。各 Pod 之间的通讯采用 Overlay Network，即全覆盖网络。
<hr></p>
<h5 id="2-k8s">2. K8S网络解决方案</h5>
<p>Flannel 是 CoreOS 团队针对Kubernetes 设计的一个网络规划服务，符合 <font>CRI</font>，即容器运行时接口。简单来说，它的功能是让 <font>集群中的不同节点主机创建的 Docker 容器都具有全集群唯一的虚拟IP地址</font>。而且它还能在这些IP 地址之间建立一个覆盖网络（Overlay Network）。通过这个覆盖网络，将数据包原封不动地传递到目标容器内。Docker 容器的 IP 唯一是容易解决的，需要修改 Docker0 分配的网段，那么容器的 IP 就是不一样。Docker 中不同容器之间的访问是比较难实现的，可以看下 Flannel 是如何解决的。</p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20200611181650862.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1RoYW5sb24=,size_16,color_FFFFFF,t_70" /></p>
<p>真实 Node 服务器上会安装一个 Flanneld 的守护进程，这个进程会监听一个端口，这个端口用于后期转发和接收数据包。<font>Flanneld 启动之后会开启网桥 Flannel0，Flannel0 专门收集 Docker0 转发出来的数据报文。Docker0会分配自己的IP到对应的Pod上</font>。如果是同一台主机的不同 Pod 之间访问走的是 Docker0 的网桥。因为这些 Pod 都是在在同一个网桥下面的子网中，是可以走 Docker0 的网桥。图示如下：</p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20200612075700510.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1RoYW5sb24=,size_16,color_FFFFFF,t_70" /></p>
<p>跨主机 <font>通过对方的IP访问对方</font>，比如 Web app02 访问 Backend，10.1.15.2/24 和 10.1.20.3/24 不是同一个网段。Web app02 把数据报文发送到投入它的网关 Docker0，Docker0 中会有对应的钩子函数把数据包抓取到 Flannel0，这里还会有很多 <font>从 ETCD 中获取的路由表记录被写入到主机</font>，用来判断路由到哪台机器。</p>
<p>Flannel0 是 Flanneld 开启的网桥，所以 <font>数据包会到 Flanneld，Flanneld 会对数据报文进行解封装</font>，目标写的是 192.168.66.2（图上的错了）。Flanneld 使用的是 udb 来转发数据包，因为局域网内更快。Payload 是外部数据包实体，<font>解封装之后数据包被转发到目标Node主机</font>。目标端口是 Flanneld 的端口，所以这个 <font>数据包会被Flanneld所截获，然后拆分数据包，再转发到 Flannel0，Flannel0 转发到 Docker0，Docker0 分配到 Backend Pod</font>。这里是经过二次解封的，第一层信息 Docker0 是看不到的，只能看到第二层。这样就可以实现跨主机的扁平化网络。图示如下：</p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/2020061207554739.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1RoYW5sb24=,size_16,color_FFFFFF,t_70" /></p>
<p>另外，Flannel 和 ETCD 之间有哪些关联。第一点：存储管理 Flannel 可分配的 IP 地址段的资源，Flannel 在启动的时候会向 ETCD 中插入可以被分配的网段，并且记录把哪个网段分配到哪些机器上，<font>防止已经分配的网段再被Flannel利用，分配到其它的Node节点</font>。第二点：监控 ETCD 中每个 Pod 的实际地址，并在内存中建立维护 Pod 节点路由表。可以利用这个路由表判断 Pod 对应的主机地址是(192.168.66.2)。
<hr></p>
<h5 id="3-k8s">3. K8S网络通信方式</h5>
<p>同一个 Pod 内部通讯：同一个Pod 共享同一个网络命名空间，共享同一个Linux 协议栈，使用的是 lo，即回环网卡。</p>
<p>两个Pod之间的访问：<font>① Pod1 与 Pod2 不在同一台主机</font>，Pod 的地址是与 docker0 在同一个网段的，但docker0网段与宿主机网卡是两个完全不同的IP网段，并且不同Node之间的通信只能通过宿主机的物理网卡进行。将Pod的IP和所在Node的IP关联起来，通过这个关联让Pod可以互相访问；<font>② Pod1 与 Pod2 在同一台机器</font>，由 Docker0 网桥直接转发请求至 Pod2，不需要经过 Flannel。</p>
<p>Pod 至 Service 的网络：目前基于性能考虑，全部为 iptables 维护和转发，<font>最新版是LVS转发和维护</font>。</p>
<p>Pod 到外网：Pod 向外网发送请求，查找路由表, 转发数据包到宿主机的网卡，宿主网卡完成路由选择后，iptables 执行 Masquerade 把源 IP 更改为宿主网卡的 IP，然后向外网服务器发送请求。<font>这是一种动态转换</font>。</p>
<p>外网访问 Pod：通过 Service 的 <font>NodePort</font> 方式，虽然是扁平化网络，但这个扁平化网络是私有网络，不能够在访问到与物理机器相连网络的主机。</p>
<p>K8S 中三层网络，如组件通讯示意图：</p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20200612080932172.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1RoYW5sb24=,size_16,color_FFFFFF,t_70" /></p>
<p>真实的物理网络只有一个就是节点网络，构建服务器的时候只需要一张网卡就可以实现。Service 网络和 Pod 网络是虚拟网络，属于内网中。所有的 Pod 都会在扁平化的网络（Pod）中通信。</p></div>
        </div>

        <footer class="col-md-12">
<div class="container-fluid" style="background:#2C2C2C;color: #c1c1c1;font-weight: bold;margin-bottom: 2px">
    <div class="row">
        <div class="col-md-12  text-center" style="padding: 40px">
            <a href="https://www.nginx.com/" style="color:#c1c1c1;font-weight: bold" target="_blank">Nginx</a>&nbsp;|
            <a href="https://zabbix.org/" style="color:#c1c1c1;font-weight: bold"
               target="_blank">Zabbix</a>&nbsp;|
            <a href="https://kubernetes.io/" style="color:#c1c1c1;font-weight: bold" target="_blank">Kubernetes</a>&nbsp;|
            <a href="https://www.centos.org/" style="color:#c1c1c1;font-weight: bold" target="_blank">CentOS</a>&nbsp;|
            <a href="https://ubuntu.com/" style="color:#c1c1c1;font-weight: bold" target="_blank">Ubuntu</a>&nbsp;
            <br>
            Copyright © 2020-2021&nbsp; pythoneers.cn. All Rights Reserved.&nbsp;运维云栈 版权所有&nbsp;
            <br>
            <a target="_blank_" href="http://www.miit.gov.cn/" style="color:#c1c1c1;">豫ICP备19037971-2号</a>
            <!--            <a target="_blank">-->
            <!--                <img src="/static/home/images/beian.png" style="padding-bottom:6px">-->
            <!--                <span style="color:#c1c1c1;">豫公网安备 41152802000091号</span>-->
            <!--            </a>-->
            <span id="cnzz_stat_icon_1279280889">
            <a href="https://www.cnzz.com/stat/website.php?web_id=1279280889" target="_blank" title="站长统计">
              <img border="0" hspace="0" vspace="0" src="https://icon.cnzz.com/img/pic.gif">
            </a>
          </span>
        </div>
    </div>
</div>

        </footer>

        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../js/gotop.js" defer></script>
<!--    <script async src="../js/somelib.js"></script>-->
<script data-ad-client="ca-pub-6937898095875663"
        src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
    //baidu自动收录
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>
<script>
    //360自动收录
    (function () {
        var src = "https://jspassport.ssl.qhimg.com/11.0.1.js?d182b3f28525f2db83acfaaf6e696dba";
        document.write('<script src="' + src + '" id="sozz"><\/script>');
    })();
</script>


        <div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
